<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#fdf2f8">
    <title>ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼</title>
    
    <!-- SNSã‚·ã‚§ã‚¢ç”¨è¨­å®š -->
    <meta property="og:title" content="ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼">
    <meta property="og:description" content="ç§ã®ä»Šã®ç››ã‚Œåº¦ã¯...ï¼Ÿ ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼ã§è¨ºæ–­ä¸­â™¡">
    <meta property="og:type" content="website">
    <meta property="og:image" content="icon.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- html-to-image (è»½é‡ãƒ»é«˜ç”»è³ªãªç”»åƒç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Yomogi&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

    <!-- ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">

    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #fdf2f8;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(#fbcfe8 20%, transparent 20%), radial-gradient(#fbcfe8 20%, transparent 20%);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
        
        .font-pop { font-family: 'Mochiy Pop One', sans-serif; }
        .font-hand { font-family: 'Yomogi', cursive; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        .purupuru { animation: purupuru 2s infinite; }
        @keyframes purupuru {
            0% { transform: scale(1, 1); }
            10% { transform: scale(1.02, 0.98); }
            40% { transform: scale(0.98, 1.02); }
            50% { transform: scale(1, 1); }
        }
        
        .floating-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        .float-item {
            position: absolute;
            opacity: 0.3;
            animation: floatUp linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 3px solid rgba(255, 255, 255, 1);
            box-shadow: 0 8px 32px 0 rgba(236, 72, 153, 0.15);
            border-radius: 32px;
        }

        /* ãƒ¡ãƒ¼ã‚¿ãƒ¼è£…é£¾ */
        .meter-track {
            background: #f3f4f6;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .meter-fill {
            background: linear-gradient(90deg, #f9a8d4, #ec4899, #fbbf24);
            box-shadow: 0 2px 4px rgba(236, 72, 153, 0.3);
        }
        .meter-icon {
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
            transition: left 0.5s ease-out;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼UI */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .calendar-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ path, className, size = 24, onClick, style }) => (
            <svg onClick={onClick} style={style} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M5 19v2"/><path d="M9 19H5"/></>} />,
            Bath: (props) => <Icon {...props} path={<><path d="M9 6 6.5 3.5a1.5 1.5 0 0 0-1-1.5C3.81 2 2.5 3.31 2.5 5.5c0 1.56 1.15 2.1 1.8 2.2"/><path d="M21 10c0-1.66-1.34-3-3-3-1.12 0-2.1.58-2.6 1.5L14 10"/><path d="M7 10h14L19.5 21h-11Z"/><path d="M7 10v4"/></>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            Share: (props) => <Icon {...props} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></>} />,
            Calendar: (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />,
            X: (props) => <Icon {...props} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            ChevronLeft: (props) => <Icon {...props} path={<><path d="m15 18-6-6 6-6"/></>} />,
            ChevronRight: (props) => <Icon {...props} path={<><path d="m9 18 6-6-6-6"/></>} />,
            AlertTriangle: (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            IosShare: (props) => <Icon {...props} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></>} />,
            Camera: (props) => <Icon {...props} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Crown: (props) => <Icon {...props} path={<><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></>} />
        };

        const BASE_RATE_PER_HOUR = 2.5; 

        // JKèªéŒ²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const TIME_MESSAGES = [
            { hour: 0, msg: "ä»ŠãŒä¸€ç•ªå¯æ„›ã„ï¼å…¨äººé¡è¦‹ã¦âœ¨" },
            { hour: 3, msg: "ã¾ã ä½™è£•ï¼ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼ã®ã„ã„åŒ‚ã„ã™ã‚‹â™¡" },
            { hour: 6, msg: "å‰é«ªã‚­ãƒ¼ãƒ—ã§ãã¦ã‚‹ï¼Ÿã¡ã‚‡ã£ã¨ç¢ºèªã—ã¦ã¿ã¦ğŸ‘€" },
            { hour: 9, msg: "ãã‚ãã‚çš®è„‚ãŒå‡ºã¦ããŸã‹ã‚‚â€¦ã‚ã¶ã‚‰ã¨ã‚Šç´™ä½¿ã†ï¼Ÿ" },
            { hour: 12, msg: "ã“ã®ã¾ã¾ã ã¨æ¨ã—ã«ä¼šãˆãªã„ã‚ˆï¼Ÿæ­£ç›´å¿ƒé…ğŸ’¦" },
            { hour: 15, msg: "è‚Œè’ã‚Œè­¦å ±ç™ºä»¤ä¸­ï¼ãŠé¢¨å‘‚å…¥ã£ã¦å¯æ„›ããªã‚ğŸ¥º" },
            { hour: 18, msg: "æ­£ç›´ã€éš£ã«ã„ã‚‹ã¨ã‚­ãƒ„ã‚¤ã‹ã‚‚ğŸ˜± é¦™æ°´ã§èª¤é­”åŒ–ã›ãªã„ã‚ˆï¼" },
            { hour: 21, msg: "ãŠè‚Œã®æ°´åˆ†é‡ã‚¼ãƒ­ï¼ç ‚æ¼ çŠ¶æ…‹ğŸ« å…¥ã£ã¦ãŠé¡˜ã„ï¼" },
            { hour: 24, msg: "é™ç•Œçªç ´ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã«æ±šã„ã‚ˆğŸ˜­ èª°ã¨ã‚‚ä¼šã‚ãªã„ã§ï¼" },
            { hour: 30, msg: "èŒã®æ¸©åºŠã«ãªã£ã¦ã‚‹ã‚ˆğŸ¦  ä»Šã™ããŠé¢¨å‘‚è¡Œã£ã¦ï¼" }
        ];

        // ãƒ€ãƒ¡ãƒ¼ã‚¸å€¤ã‚’ãƒã‚¤ãƒ«ãƒ‰ã«èª¿æ•´
        const EVENT_DAMAGES = {
            sleep: { label: "å¯ã¦èµ·ããŸ", damage: 10, emoji: "ğŸ›Œ", msg: "èµ·ããŸã‚‰é«ªãƒœã‚µãƒœã‚µã€œğŸ’¦ å¯æ±—ã‹ã„ãŸï¼" },
            train: { label: "æº€å“¡é›»è»Š", damage: 12, emoji: "ğŸšƒ", msg: "å¯†ç€ã‚„ã°ã™ãâ€¦è’¸ã‚Œã¦ã‚‹æ°—ãŒã™ã‚‹ğŸ’§" },
            outing: { label: "ã¡ã‚‡ã£ã¨å¤–å‡º", damage: 8, emoji: "ğŸ‘œ", msg: "å¤–ã®ç©ºæ°—æ±šã™ãâ€¦ãƒ›ã‚³ãƒªã¤ã„ãŸã‹ã‚‚ğŸ¤§" },
            rain: { label: "é›¨ãƒ»æ¹¿æ°—", damage: 8, emoji: "â˜”", msg: "æ¹¿æ°—ã§é«ªçµ‚ã‚ã£ãŸâ€¦ã†ã­ã‚ŠMAXğŸ˜­" },
            exercise: { label: "ä½“è‚²ãƒ»é‹å‹•", damage: 20, emoji: "ğŸƒâ€â™€ï¸", msg: "æ±—ã‚„ã°ã„ï¼ã“ã‚Œã¯å³ã‚·ãƒ£ãƒ¯ãƒ¼æ¡ˆä»¶ğŸš¿" },
            live: { label: "ãƒ©ã‚¤ãƒ–ãƒ»æ¨ã—æ´»", damage: 25, emoji: "ğŸ¤", msg: "æ±—ã ãã§å®Œå…¨ç‡ƒç„¼ğŸ”¥ æ¥½ã—ã‹ã£ãŸã‘ã©ä½“ãƒ™ã‚¿ãƒ™ã‚¿ï¼" },
            food: { label: "ç„¼è‚‰/æšã’ç‰©", damage: 15, emoji: "ğŸ¥©", msg: "åŒ‚ã„ã¤ã„ã¡ã‚ƒã£ãŸâ€¦ãƒ•ã‚¡ãƒ–ãƒªãƒ¼ã‚ºã˜ã‚ƒç„¡ç†ğŸ˜­" },
            ramen: { label: "ãƒ©ãƒ¼ãƒ¡ãƒ³", damage: 15, emoji: "ğŸœ", msg: "ãƒ‹ãƒ³ãƒ‹ã‚¯èƒŒè„‚â€¦ç¾å‘³ã—ã„ã‘ã©é«ªã«åŒ‚ã„ãŒğŸ˜±" },
            allnight: { label: "å¾¹å¤œãƒ»ã‚ªãƒ¼ãƒ«", damage: 20, emoji: "ğŸŒ™", msg: "è‚Œè’ã‚Œç¢ºå®šæ¼”å‡ºã€‚åŒ–ç²§ãƒãƒªæœ€æ‚ªã«ãªã‚Šãã†ğŸ’€" },
            mask: { label: "ãšã£ã¨ãƒã‚¹ã‚¯", damage: 3, emoji: "ğŸ˜·", msg: "å£å‘¨ã‚ŠãŒè’¸ã‚Œã¦ã‚‹â€¦è‚Œè’ã‚Œæ³¨æ„å ±ğŸš¨" }
        };

        const STORAGE_KEY_HP = 'hq_hp';
        const STORAGE_KEY_LAST_BATH = 'hq_last_bath';
        const STORAGE_KEY_DAMAGE = 'hq_damage';
        const STORAGE_KEY_LOGS = 'hq_logs';
        const STORAGE_KEY_HISTORY = 'hq_history';
        const STORAGE_KEY_USER_ID = 'hq_user_id';

        const FloatingBackground = () => (
            <div className="floating-bg">
                {[...Array(15)].map((_, i) => (
                    <div key={i} className="float-item" style={{
                        left: `${Math.random() * 100}%`,
                        animationDuration: `${15 + Math.random() * 20}s`,
                        animationDelay: `${Math.random() * 10}s`,
                        fontSize: `${10 + Math.random() * 20}px`
                    }}>
                        {i % 3 === 0 ? 'ğŸ’–' : i % 3 === 1 ? 'âœ¨' : 'ğŸ›'}
                    </div>
                ))}
            </div>
        );

        const InAppBrowserWarning = ({ onClose }) => {
            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 modal-enter">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm text-center relative border-4 border-pink-400">
                        <div className="text-pink-500 mb-2 flex justify-center"><Icons.AlertTriangle size={48} /></div>
                        <h2 className="text-xl font-black text-gray-800 mb-2 font-pop">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¡ã‚ƒã†ã‹ã‚‚ï¼</h2>
                        <p className="text-sm text-gray-600 mb-4 font-bold">ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã›ã‚“ğŸ’¦</p>
                        <div className="bg-gray-100 p-4 rounded-xl text-left mb-4 text-sm text-gray-700">
                            <p className="mb-2 font-bold">ğŸ‘‡ ã“ã†ã—ã¦ã­ï¼</p>
                            <ol className="list-decimal list-inside">
                                <li>å³ä¸Šã® <span className="font-bold bg-white px-1 rounded">ï¸™</span> ã‚„ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
                                <li><span className="font-bold text-blue-600">ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€</span> ã‚’é¸ã¶</li>
                            </ol>
                        </div>
                        <button onClick={onClose} className="text-xs text-gray-400 underline p-2">åˆ†ã‹ã£ãŸã‘ã©ã“ã®ã¾ã¾ä½¿ã†</button>
                    </div>
                </div>
            );
        };

        const InstallGuide = ({ onClose }) => {
            const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
            return (
                <div className="fixed bottom-0 left-0 right-0 p-4 z-40 slide-up pb-safe">
                    <div className="bg-gray-800/95 backdrop-blur text-white rounded-2xl p-4 shadow-2xl relative border border-pink-400">
                        <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 p-2"><Icons.X size={18} /></button>
                        <div className="flex items-start gap-4">
                            <div className="bg-pink-500 p-3 rounded-xl shrink-0"><Icons.Download size={24} /></div>
                            <div>
                                <h3 className="font-bold text-sm mb-1 font-pop">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã‚ˆã†ï¼</h3>
                                <p className="text-xs text-gray-300 mb-2">ã‚¢ãƒ—ãƒªã¿ãŸã„ã«ä½¿ãˆã¦ã€å…¨ç”»é¢ã§è¦‹ã‚„ã™ããªã‚‹ã‚ˆâœ¨</p>
                                <div className="text-xs font-bold text-pink-300 flex items-center gap-1">
                                    {isIOS ? <><span className="bg-gray-600 px-1 rounded inline-flex"><Icons.IosShare size={12}/></span> ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</> : <>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span className="bg-gray-600 px-1 rounded">ï¸™</span> ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CalendarModal = ({ isOpen, onClose, history }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            if (!isOpen) return null;
            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const days = [];
                for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
                for (let i = 1; i <= lastDay.getDate(); i++) days.push(new Date(year, month, i));
                return days;
            };
            const changeMonth = (delta) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + delta);
                setCurrentDate(newDate);
            };
            const days = getDaysInMonth(currentDate);
            const monthLabel = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
            const historySet = new Set(history);
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        <h2 className="text-xl font-black text-pink-500 text-center mb-4 flex items-center justify-center gap-2 font-pop"><Icons.Calendar size={20}/> å…¥æµ´ã‚¹ã‚¿ãƒ³ãƒ—å¸³</h2>
                        <div className="flex justify-between items-center mb-4 px-2">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-full"><Icons.ChevronLeft size={20}/></button>
                            <span className="font-bold text-gray-700">{monthLabel}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-full"><Icons.ChevronRight size={20}/></button>
                        </div>
                        <div className="calendar-grid mb-2 text-center text-xs font-bold text-gray-400">
                            <div className="text-red-400">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div className="text-blue-400">åœŸ</div>
                        </div>
                        <div className="calendar-grid gap-y-3">
                            {days.map((date, i) => {
                                if (!date) return <div key={i}></div>;
                                const dateStr = date.toISOString().split('T')[0];
                                const isClean = historySet.has(dateStr);
                                const isToday = date.toDateString() === new Date().toDateString();
                                return (
                                    <div key={i} className="calendar-cell relative">
                                        <span className={`text-xs mb-1 w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-pink-500 text-white font-bold' : 'text-gray-600'}`}>
                                            {date.getDate()}
                                        </span>
                                        {isClean && <span className="absolute text-lg animate-bounce" style={{top: '2px'}}>ğŸ’®</span>}
                                    </div>
                                );
                            })}
                        </div>
                        <p className="text-xs text-center text-gray-400 mt-6 font-hand">ãŠé¢¨å‘‚ã«å…¥ã‚‹ã¨ã‚¹ã‚¿ãƒ³ãƒ—ãŒæŠ¼ã•ã‚Œã‚‹ã‚ˆï¼<br/>æ¯æ—¥åŸ‹ã‚ã¦ç¾æ„è­˜é«˜ã‚ã‚ˆã†âœ¨</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [hp, setHp] = useState(100);
            const [lastBathTime, setLastBathTime] = useState(new Date());
            const [eventDamageTotal, setEventDamageTotal] = useState(0);
            const [logs, setLogs] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [currentMsg, setCurrentMsg] = useState("");
            const [quickAction, setQuickAction] = useState(null);
            const [lastAppliedTimeMsg, setLastAppliedTimeMsg] = useState("");
            const [lastActionTime, setLastActionTime] = useState(new Date(0));
            const [bathHistory, setBathHistory] = useState([]);
            const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [showInAppWarning, setShowInAppWarning] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            const [userId, setUserId] = useState("");
            
            // ç”»åƒç”Ÿæˆç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedImage, setGeneratedImage] = useState(null);

            useEffect(() => {
                const loadData = () => {
                    try {
                        const savedHp = localStorage.getItem(STORAGE_KEY_HP);
                        const savedLastBath = localStorage.getItem(STORAGE_KEY_LAST_BATH);
                        const savedDamage = localStorage.getItem(STORAGE_KEY_DAMAGE);
                        const savedLogs = localStorage.getItem(STORAGE_KEY_LOGS);
                        const savedHistory = localStorage.getItem(STORAGE_KEY_HISTORY);
                        let savedUserId = localStorage.getItem(STORAGE_KEY_USER_ID);
                        if (!savedUserId) {
                            savedUserId = 'ID-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                            localStorage.setItem(STORAGE_KEY_USER_ID, savedUserId);
                        }
                        setUserId(savedUserId);
                        if (savedHp) setHp(parseFloat(savedHp));
                        if (savedLastBath) setLastBathTime(new Date(savedLastBath));
                        if (savedDamage) setEventDamageTotal(parseFloat(savedDamage));
                        if (savedLogs) setLogs(JSON.parse(savedLogs));
                        if (savedHistory) setBathHistory(JSON.parse(savedHistory));
                    } catch (e) { console.error("Failed to load data", e); }
                };
                loadData();
                const ua = navigator.userAgent.toLowerCase();
                const isInApp = /line|instagram|twitter|fbav|fban/.test(ua);
                if (isInApp) setShowInAppWarning(true);
                else {
                    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                    if (!isStandalone) { setTimeout(() => setShowInstallGuide(true), 2000); }
                }
                const params = new URLSearchParams(window.location.search);
                const action = params.get('action');
                if (action) {
                    if (action === 'bath') setTimeout(() => setQuickAction({ type: 'bath' }), 500);
                    else if (EVENT_DAMAGES[action]) setTimeout(() => setQuickAction({ type: 'event', key: action }), 500);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_HP, hp.toString());
                localStorage.setItem(STORAGE_KEY_LAST_BATH, lastBathTime.toISOString());
                localStorage.setItem(STORAGE_KEY_DAMAGE, eventDamageTotal.toString());
                localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(logs));
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(bathHistory));
            }, [hp, lastBathTime, eventDamageTotal, logs, bathHistory]);

            useEffect(() => {
                const timer = setInterval(() => { setCurrentTime(new Date()); }, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const diffMs = new Date() - lastBathTime;
                const hoursElapsed = (diffMs / (1000 * 60 * 60));
                const baseDamage = hoursElapsed * BASE_RATE_PER_HOUR;
                const totalDamage = baseDamage + eventDamageTotal;
                let currentHp = 100 - totalDamage;
                currentHp = Math.max(0, Math.min(100, currentHp));
                setHp(currentHp);
                if (new Date() - lastActionTime < 8000) return;
                const roundedHour = Math.floor(hoursElapsed);
                const msgObj = TIME_MESSAGES.slice().reverse().find(m => roundedHour >= m.hour);
                if (msgObj && msgObj.msg !== lastAppliedTimeMsg) {
                    setCurrentMsg(msgObj.msg);
                    setLastAppliedTimeMsg(msgObj.msg);
                }
            }, [currentTime, lastBathTime, eventDamageTotal, lastAppliedTimeMsg, lastActionTime]);
            
            useEffect(() => {
                if (quickAction) {
                    if (quickAction.type === 'bath') handleBath();
                    else if (quickAction.type === 'event') handleEvent(quickAction.key);
                    setQuickAction(null);
                }
            }, [quickAction]);

            const handleEvent = (eventKey) => {
                const event = EVENT_DAMAGES[eventKey];
                // ã‚­ãƒ£ãƒƒãƒ—æ’¤å»ƒï¼šå˜ç´”åŠ ç®—
                setEventDamageTotal(prev => prev + event.damage);
                addLog(event.msg, event.emoji);
                setCurrentMsg(event.msg);
                setLastActionTime(new Date());
                if (navigator.vibrate) navigator.vibrate(50);
            };

            const handleBath = () => {
                setLastBathTime(new Date());
                setEventDamageTotal(0);
                setHp(100);
                addLog("ãŠé¢¨å‘‚å…¥ã£ã¦å¾©æ´»ï¼ä»Šæ—¥ã‚‚ç§ãŒä¸€ç•ªã‚«ãƒ¯ã‚¤ã‚¤ğŸ’–", "ğŸ›");
                setCurrentMsg("ãŠé¢¨å‘‚ä¸ŠãŒã‚Šæœ€é«˜ã€œâœ¨ ä»ŠãŒä¸€ç•ªå¯æ„›ã„ï¼");
                setLastAppliedTimeMsg("ãŠé¢¨å‘‚ä¸ŠãŒã‚Šæœ€é«˜ã€œâœ¨ ä»ŠãŒä¸€ç•ªå¯æ„›ã„ï¼");
                setLastActionTime(new Date());
                const today = new Date().toISOString().split('T')[0];
                setBathHistory(prev => {
                    const newHistory = new Set(prev);
                    newHistory.add(today);
                    return Array.from(newHistory);
                });
                if (navigator.vibrate) navigator.vibrate([0, 100, 50, 100]);
            };

            const getStatusDesign = (currentHp) => {
                if (currentHp >= 80) return { 
                    avatar: "ğŸ‘¸", label: "å¤§å‹åˆ©", 
                    deco: "ğŸ‘‘", 
                    shareMsg: "ä»ŠãŒä¸€ç•ªå¯æ„›ã„ï¼å…¨äººé¡è¦‹ã¦âœ¨",
                    glowColor: "bg-pink-400"
                };
                if (currentHp >= 50) return { 
                    avatar: "ğŸ˜", label: "å¤©ä½¿", 
                    deco: "âœ¨", 
                    shareMsg: "ã¾ã èˆãˆã‚‹â€¦ã¯ãšã€‚èª°ã‹ãŠé¢¨å‘‚å…¥ã‚Œã¦ğŸ¥º",
                    glowColor: "bg-yellow-200"
                };
                if (currentHp >= 20) return { 
                    avatar: "ğŸ˜°", label: "é™ç•Œ", 
                    deco: "ğŸ’¦", 
                    shareMsg: "æ¸…æ½”æ„Ÿè¡Œæ–¹ä¸æ˜ã€‚åŠå¾„2mä»¥å†…ç«‹ã¡å…¥ã‚Šç¦æ­¢âš ï¸",
                    glowColor: "bg-purple-300"
                };
                return { 
                    avatar: "ğŸ§Ÿâ€â™€ï¸", label: "çµ‚äº†", 
                    deco: "ğŸ’€", 
                    shareMsg: "ç¤¾ä¼šçš„ã«æ­»ã«ã¾ã—ãŸğŸ˜‡ è˜‡ç”Ÿ(å…¥æµ´)æ±‚ã‚€â€¦",
                    glowColor: "bg-gray-500"
                };
            };

            const handleShare = async () => {
                const hoursSinceBath = ((new Date() - lastBathTime) / (1000 * 60 * 60)).toFixed(1);
                const status = getStatusDesign(hp);
                let shareUrl = window.location.href.split('?')[0]; 
                
                const text = `
ğŸ«§ ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼ ğŸ«§

çµŒéæ™‚é–“ï¼š${hoursSinceBath}æ™‚é–“
æ¸…æ½”åº¦ã€€ï¼š${Math.floor(hp)}% (${status.label})

ã€Œ${status.shareMsg}ã€

#ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼
${shareUrl}`;

                if (navigator.share) {
                    try { await navigator.share({ title: 'ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼', text: text.trim() }); return; } 
                    catch (err) { if (err.name === 'AbortError') return; }
                }
                try {
                    await navigator.clipboard.writeText(text.trim());
                    alert('æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼SNSã«è²¼ã‚Šä»˜ã‘ã¦ã­ğŸ“‹\n\n' + text.trim());
                } catch (err) {
                    const isYes = confirm('æ–‡ç« ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸğŸ’¦\nä»£ã‚ã‚Šã«Twitter(X)ã®æŠ•ç¨¿ç”»é¢ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ');
                    if (isYes) { window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text.trim())}`, '_blank'); }
                }
            };

            // ç”»åƒç”Ÿæˆé–¢æ•°ï¼ˆhtml-to-imageã‚’ä½¿ç”¨ï¼‰
            const generateShareImage = async () => {
                setIsGenerating(true);
                const node = document.getElementById('share-target');

                try {
                    await new Promise(resolve => setTimeout(resolve, 100)); // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾…ã¡

                    const dataUrl = await htmlToImage.toPng(node, {
                        quality: 1.0,
                        pixelRatio: 3, // é«˜ç”»è³ªè¨­å®š
                        style: { transform: 'scale(1)' }
                    });

                    setGeneratedImage(dataUrl);

                    if (navigator.canShare && navigator.canShare({ files: [new File([], 'test.png')] })) {
                        const blob = await (await fetch(dataUrl)).blob();
                        const file = new File([blob], "ofuro-checker.png", { type: "image/png" });
                        try {
                            await navigator.share({
                                title: 'ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼',
                                text: `æ¸…æ½”åº¦${Math.floor(hp)}%ï¼ ${getStatusDesign(hp).shareMsg} #ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼`,
                                files: [file],
                            });
                        } catch (err) {}
                    }
                } catch (error) {
                    console.error('oops, something went wrong!', error);
                    alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸğŸ’¦');
                } finally {
                    setIsGenerating(false);
                }
            };

            const addLog = (text, icon) => {
                const now = new Date();
                const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                setLogs(prev => {
                    const newLogs = [{ time: timeStr, text: text, icon: icon || "ğŸ“±" }, ...prev];
                    return newLogs.slice(0, 50);
                });
            };

            const status = getStatusDesign(hp);
            const hoursSinceBath = ((new Date() - lastBathTime) / (1000 * 60 * 60)).toFixed(1);

            return (
                <div className={`min-h-screen w-full flex flex-col items-center py-6 px-4 transition-colors duration-500 font-sans pb-safe relative`}>
                    
                    <FloatingBackground />

                    {showInAppWarning && <InAppBrowserWarning onClose={() => setShowInAppWarning(false)} />}
                    {showInstallGuide && <InstallGuide onClose={() => setShowInstallGuide(false)} />}
                    
                    {/* â–¼â–¼â–¼ 1. æ’®å½±å°‚ç”¨ã®éš ã—ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Ver 6.2ã§ä¿®æ­£) â–¼â–¼â–¼ */}
                    <div style={{ position: 'fixed', top: '-9999px', left: '-9999px' }}>
                        <div id="share-target" className="w-[375px] h-[600px] bg-[#fdf2f8] p-8 flex flex-col items-center justify-center relative overflow-hidden text-center border-4 border-white">
                            <div className="absolute inset-0 opacity-20" style={{
                                backgroundImage: 'radial-gradient(#fbcfe8 20%, transparent 20%)',
                                backgroundSize: '20px 20px'
                            }}></div>
                            
                            <div className="bg-white/90 px-4 py-2 rounded-full border-2 border-pink-200 shadow-sm mb-4 z-10">
                                <h1 className="text-xl font-black text-pink-500 font-pop">ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
                            </div>

                            <div className="mb-4 relative z-10 scale-110">
                                <div className="text-8xl filter drop-shadow-xl">{status.avatar}</div>
                                <div className="absolute -top-4 -right-4 text-5xl">{status.deco}</div>
                            </div>
                            
                            {/* â˜…ã“ã“ã«è¿½åŠ ï¼šæ™‚é–“è¡¨ç¤ºâ˜… */}
                            <div className="bg-white/60 p-4 rounded-xl border border-pink-100 mb-4 w-full z-10">
                                <div className="text-xs font-bold text-pink-400 mb-1">ãŠé¢¨å‘‚ã«å…¥ã‚‰ãš...</div>
                                <div className="text-5xl font-black text-pink-600 font-pop leading-none">
                                    {hoursSinceBath}<span className="text-lg ml-1">æ™‚é–“</span>
                                </div>
                            </div>

                            <div className="bg-white/80 rounded-2xl p-4 border-2 border-pink-100 shadow-md w-full z-10">
                                <div className="flex justify-between items-end mb-2 border-b border-pink-100 pb-2">
                                    <span className="font-bold text-gray-500 text-sm">ç¾åœ¨ã®æ¸…æ½”åº¦</span>
                                    <span className="font-black text-4xl text-pink-500 font-pop">{Math.floor(hp)}%</span>
                                </div>
                                <div className="text-left">
                                     <span className={`text-xs font-bold text-white px-2 py-1 rounded ${status.glowColor.replace('bg-', 'bg-')}`}>
                                        çŠ¶æ…‹ï¼š{status.label}
                                    </span>
                                </div>
                                <p className="mt-3 text-sm font-bold text-gray-700 font-hand leading-relaxed">
                                    ã€Œ{status.shareMsg}ã€
                                </p>
                            </div>

                            <div className="mt-8 text-gray-400 text-xs font-bold font-pop flex items-center gap-2 opacity-70">
                                <span>ğŸ› ãŠé¢¨å‘‚å…¥ã£ã¦ç››ã‚Œåº¦UPï¼</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* â–¼â–¼â–¼ 2. ç”Ÿæˆç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« â–¼â–¼â–¼ */}
                    {generatedImage && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onClick={() => setGeneratedImage(null)}>
                            <div className="bg-white rounded-3xl p-4 w-full max-w-sm relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setGeneratedImage(null)} className="absolute -top-3 -right-3 bg-gray-500 text-white p-2 rounded-full"><Icons.X size={16}/></button>
                                <h3 className="text-center font-bold text-gray-700 mb-2 font-pop">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ã­ï¼</h3>
                                <img src={generatedImage} alt="Share" className="w-full rounded-xl border border-gray-200 shadow-inner" />
                                <p className="text-center text-xs text-gray-400 mt-2">Twitterã‚„Instagramã§ã‚·ã‚§ã‚¢âœ¨</p>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="w-full flex justify-between items-center pt-safe mb-6 mt-2 relative z-20 px-2">
                        <button onClick={() => setIsCalendarOpen(true)} className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform shrink-0">
                            <Icons.Calendar size={24} />
                        </button>

                        <div className="inline-block bg-white/90 px-3 py-1.5 rounded-full border-2 border-pink-200 shadow-sm mx-1 flex-1 min-w-0 flex justify-center">
                            <h1 className="text-sm sm:text-base font-black text-pink-500 tracking-normal flex items-center justify-center whitespace-nowrap overflow-hidden font-pop">
                                ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼
                            </h1>
                        </div>

                        {/* ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ç¾¤ */}
                        <div className="flex gap-2 shrink-0">
                            {/* ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ */}
                            <button onClick={generateShareImage} disabled={isGenerating} className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform shrink-0 disabled:opacity-50">
                                {isGenerating ? <div className="animate-spin w-6 h-6 border-2 border-pink-500 border-t-transparent rounded-full"></div> : <Icons.Camera size={24} />}
                            </button>
                            {/* ãƒ†ã‚­ã‚¹ãƒˆãƒœã‚¿ãƒ³ */}
                            <button onClick={handleShare} className="bg-white/80 p-3 rounded-full shadow-md text-blue-500 hover:scale-110 transition-transform shrink-0">
                                <Icons.Share size={24} />
                            </button>
                        </div>
                    </div>

                    {/* Main Card */}
                    <div className="w-full max-w-sm glass-card rounded-3xl p-6 mb-6 text-center relative overflow-visible transition-all duration-300">
                        <div className="absolute -top-6 -right-6 text-6xl animate-bounce z-20 filter drop-shadow-lg">{status.deco}</div>
                        
                        <div className="absolute top-0 left-0 bg-pink-500 text-white text-xs font-bold px-3 py-1 rounded-br-2xl rounded-tl-2xl shadow-sm z-10 font-pop">
                            {status.label}
                        </div>

                        <div className="w-48 h-48 mx-auto mt-6 mb-6 relative purupuru select-none flex items-center justify-center">
                            <div className={`absolute inset-0 rounded-full opacity-50 blur-xl ${status.glowColor}`}></div>
                            <div className="relative z-10 text-9xl">{status.avatar}</div>
                        </div>
                        
                        <div className="relative pt-1 mb-2">
                            <div className="flex mb-2 items-center justify-between font-pop">
                                <span className="text-sm font-bold inline-block py-1 px-3 uppercase rounded-full text-white bg-pink-400 shadow-md">
                                    ç››ã‚Œåº¦
                                </span>
                                <span className="text-2xl font-black text-pink-500 drop-shadow-sm">{Math.floor(hp)}%</span>
                            </div>
                            
                            <div className="h-6 w-full rounded-full meter-track relative mt-2">
                                <div style={{ width: `${hp}%` }} className="h-full rounded-full meter-fill relative"></div>
                                <div style={{ left: `calc(${hp}% - 12px)` }} className="absolute top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center meter-icon">
                                    <span className="text-2xl">ğŸ’–</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="relative bg-white/80 rounded-xl p-4 border-2 border-pink-100 shadow-sm mt-4">
                            <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white border-t-2 border-l-2 border-pink-100 rotate-45"></div>
                            <p className="font-bold text-gray-700 leading-relaxed text-sm font-hand">
                                {currentMsg || "è¨ˆç®—ä¸­..."}
                            </p>
                        </div>
                    </div>

                    <div className="bg-white/80 px-6 py-3 rounded-2xl mb-6 shadow-md border-2 border-white flex items-center justify-between w-full max-w-sm">
                        <div className="flex items-center gap-2 text-pink-400">
                            <Icons.Clock size={20} />
                            <span className="text-xs font-bold">çµŒéæ™‚é–“</span>
                        </div>
                        <span className="text-2xl font-black text-pink-500 font-pop">{hoursSinceBath}<span className="text-sm ml-1 text-pink-400">H</span></span>
                    </div>

                    <div className="w-full max-w-sm mb-6">
                        <div className="text-xs font-bold text-gray-400 mb-2 pl-2 font-pop">â–¼ ãªã«ã—ã¦ãŸï¼Ÿ (ã‚¿ãƒƒãƒ—ã§è¿½åŠ )</div>
                        <div className="grid grid-cols-2 gap-3">
                            {Object.keys(EVENT_DAMAGES).map(key => (
                                <button key={key} onClick={() => handleEvent(key)} className="bg-white/90 hover:bg-pink-50 border-2 border-pink-100 text-gray-700 py-3 px-3 rounded-2xl shadow-sm active:scale-95 transition-transform flex items-center gap-3 text-left w-full">
                                    <span className="text-2xl min-w-[30px] text-center select-none">{EVENT_DAMAGES[key].emoji}</span>
                                    <span className="text-xs font-bold leading-tight flex-1 font-hand">{EVENT_DAMAGES[key].label}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    <button onClick={handleBath} className="w-full max-w-sm bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500 text-white font-black py-4 rounded-full shadow-lg border-4 border-white active:scale-95 transition-all mb-8 flex items-center justify-center gap-2 text-lg font-pop">
                        <Icons.Bath size={24} />
                        <span>ãŠé¢¨å‘‚å…¥ã£ã¦ãƒªã‚»ãƒƒãƒˆâœ¨</span>
                    </button>

                    <div className="w-full max-w-sm bg-white/50 rounded-2xl p-4 h-48 overflow-y-auto border border-white scrollbar-hide">
                        <h3 className="text-xs font-bold text-gray-400 mb-3 pl-1 sticky top-0 bg-transparent font-pop">HISTORY</h3>
                        <div className="space-y-3">
                            {logs.map((log, index) => (
                                <div key={index} className="flex gap-3 animate-fade-in-up">
                                    <div className="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center flex-shrink-0 text-lg border border-pink-200 select-none">{log.icon}</div>
                                    <div className="bg-white p-2 rounded-r-xl rounded-bl-xl text-xs shadow-sm border border-gray-100 flex-1">
                                        <div className="text-gray-400 text-[10px] mb-0.5 font-pop">{log.time}</div>
                                        <div className="text-gray-600 font-hand">{log.text}</div>
                                    </div>
                                </div>
                            ))}
                            {logs.length === 0 && <p className="text-xs text-gray-400 text-center py-4 font-hand">ã¾ã å±¥æ­´ã¯ãªã„ã‚ˆï¼</p>}
                        </div>
                    </div>

                    <CalendarModal 
                        isOpen={isCalendarOpen} 
                        onClose={() => setIsCalendarOpen(false)} 
                        history={bathHistory}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>